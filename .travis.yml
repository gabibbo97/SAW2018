---
dist: xenial

services:
  - docker

language: minimal

addons:
  apt:
    packages:
      - wget
      - lftp

jobs:
  include:
    - stage: Lint
      before_script:
      # Prepara i container per il lancio
        - docker pull php:latest
      script:
      # Usa il linter di PHP
        - docker run --rm -it -v $(pwd)/:/saw --entrypoint find php:latest /saw -name '*.php' -type f -exec php -l -f {} \;
    - stage: Lint
      before_script:
      # Prepara i container per il lancio
        - docker pull phpstan/phpstan
      script:
      # Analizza staticamente il PHP
        - docker run --rm -it -v $(pwd)/:/saw phpstan/phpstan analyze --level=max /saw || true
    - stage: Lint
      before_script:
      # Prepara i container per il lancio
        - docker pull node:latest
      # Lancia in background il container
        - docker run --rm --detach --name node -v $(pwd)/.eslintrc.json:/eslintrc.json -v $(pwd)/:/saw node:latest tail -f /dev/null
      # Installa i tool nel container
        - docker exec node npm install -g eslint
      script:
      # Analizza staticamente il JS
        - docker exec node eslint --config /eslintrc.json /saw/**/*.js || true
      after_script:
      # Spegni il container
        - docker rm --force node
    - stage: Validate
      before_script:
      # Prepara i container per il lancio
        - docker pull validator/validator
      script:
      # Valida staticamente i contenuti
        - docker run --rm -it -v $(pwd)/:/saw validator/validator java -jar /vnu.jar --skip-non-html --also-check-css --format text /saw || true
    - stage: Validate
      before_script:
      # Prepara i container per il lancio
        - docker pull validator/validator
        - docker-compose pull
      # Attiva il sito web
        - docker-compose up --detach
      # Attendi che sia online
        - until wget -q --spider http://127.0.0.1:8080; do sleep 1; done
      # Scarica ogni singola pagina
        - wget --recursive --level=4096 --convert-links --page-requisites --no-directories --directory-prefix=downloaded http://127.0.0.1:8080
      script:
      # Valida le pagine scaricate
        - docker run --rm -it -v $(pwd)/downloaded:/saw validator/validator java -jar /vnu.jar --skip-non-html --also-check-css --format text /saw
      after_script:
      # Spegni il sito
        - docker-compose down
    - stage: Upload
      script:
      # Carica sul server
        - lftp -e "set sftp:auto-confirm yes; mirror --continue --delete --recursion=always --reverse --verbose lib lib; exit" -u ${USER},${PASS} sftp://${SERVER}        
        - lftp -e "set sftp:auto-confirm yes; mirror --continue --delete --recursion=always --reverse --verbose html public_html; exit" -u ${USER},${PASS} sftp://${SERVER}

notifications:
  email:
    - alessandro.orlich@live.it
    - gabibbo97@gmail.com
    - roberta.tassara.97@gmail.com
